###  使用示例

* 客户端

  ```
  public class MessengerService extends Service {
  
      private Messenger mMessenger;
  
      @Override
      public void onCreate() {
          super.onCreate();
          HandlerThread ht = new HandlerThread(getClass().getSimpleName());
          ht.start();
  
          mMessenger = new Messenger(new Handler(ht.getLooper()) {
              @Override
              public void handleMessage(Message msg) {
  
                  Logger.d("服务端接收到[%d]:%s", msg.what, msg.obj);
  
                  //客户端回发
                  Message message = Message.obtain();
                  message.what = 0x02;
                  message.obj = "echo " + msg.obj;
                  try {
                      Logger.d("服务端echo[%d]:%s", message.what, message.obj);
                      msg.replyTo.send(message);
                  } catch (RemoteException e) {
                      e.printStackTrace();
                  }
  
                  super.handleMessage(msg);
              }
          });
      }
  
      @Nullable
      @Override
      public IBinder onBind(Intent intent) {
          return mMessenger.getBinder();
      }
  }
  ```

* 客户端

  ```
  private void startMessenger() {
      // 1.bind
      Intent intent = new Intent();
      intent.setAction("com.ming.messengerService");
      intent.setPackage(getActivity().getPackageName());
      mContext.bindService(intent, mConn, Context.BIND_AUTO_CREATE);
  
  }
  private ServiceConnection mConn = new ServiceConnection() {
      @Override
      public void onServiceConnected(ComponentName componentName, IBinder iBinder) {
          // 客户端的Messenger
          HandlerThread ht = new HandlerThread("MessengerClient");
          ht.start();
          Messenger clientMessenger = new Messenger(new Handler(ht.getLooper()) {
              @Override
              public void handleMessage(Message msg) {
                  super.handleMessage(msg);
                  // 3. rec
                  Logger.d("客户端接收[%d]:%s", msg.what, msg.obj);
              }
          });
  
          // 2.send
          // 服务端的Messenger
          Messenger serverMessenger = new Messenger(iBinder);
          Message message = Message.obtain();
          message.what = 0x01;
          message.obj = "Hello messenger!";
          message.replyTo = clientMessenger;//注意指定回信人
          try {
              serverMessenger.send(message);
              Logger.d("客户端发送[%d]:%s", message.what, message.obj);
          } catch (RemoteException e) {
              e.printStackTrace();
          }
  
      }
  
      @Override
      public void onServiceDisconnected(ComponentName componentName) {
      }
  };
  ```


* 重点步骤
  * 服务端只需要创建一个 Messenger 对象，然后给它传递一个 Handler，在 Handler 中处理收发消息
  * 客户端
    * 收消息
      * 跟服务端一样，创建一个Messenger 对象
    * 发消息
      * 通过bindService获取服务端IBinder
      * 通过IBinder获取服务端Messenger，有了服务端Messenger就可以发送消息了
      * 注意指定回信人



### 源码分析

* 